<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Bootstrap demo</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
      </head>
      <body>
       <nav class="navbar navbar-expand-lg bg-light mb-3">
      <div class="container">
        <a class="navbar-brand" href="#">
            <img src="https://dynamic.brandcrowd.com/asset/logo/a2ea32a5-2049-44d3-813b-6e895d00a61f/logo-search-grid-1x?logoTemplateVersion=1&v=637662604811930000" alt="Logo" width="36" height="30" class="d-inline-block align-text-top">
            Lavender
          </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          </ul>
          <ul class="navbar-nav  mb-2 mb-lg-0">
            <li class="nav-item me-4">
              <a class="nav-link active" aria-current="page" href="#">Forum</a>
            </li>
            <li class="nav-item me-4">
              <a class="nav-link active" aria-current="page" href="#">FAQs</a>
            </li>
            <li class="nav-item me-4">
              <a class="nav-link active" aria-current="page" href="#">Blog</a>
            </li>
          </ul>
            <button class="btn btn-outline-success me-2" type="submit">Log In</button>
          <button class="btn btn-success me-2" type="submit"> Sign up</button> 
        </div>
      </div>
    </nav>

    <div class="container">
        <div class="row" id="product">
        </div>
      </div>
    <script>
        var amount;
        const params = new URLSearchParams(location.search);
        const data = JSON.parse(decodeURIComponent(params.get("data")));
        fetch('/api/products/' + data.id, {
            method: 'GET'
        })
            .then((response) => response.json())
            .then((data) => {
                amount = data.price;
                var card =
                    ` <div class="col-md-6">
                <img
                  src="${data.image_url}"
                  alt="Product Image"
                  height="360"
                />
              </div>
              <div class="col-md-6">
                <h1 class="product-title">${data.name}</h1>
                <p class="product-description">${data.description}</p>
                <p class="product-price">Rs. ${data.price}</p>
                <button class="btn btn-primary" id="rzp-button1">Pay Now</button>
              </div>`;

                document.getElementById('product').innerHTML = card;
                amount = amount * 100;
                var settings = {
                    "url": "/create/orderId",
                    "method": "POST",
                    "timeout": 0,
                    "headers": {
                        "Content-Type": "application/json"
                    },
                    "data": JSON.stringify({
                        "amount": amount
                    }),
                };

                //creates new orderId everytime
                $.ajax(settings).done(function (response) {

                    orderId = response.orderId;
                    console.log(orderId);
                    // $("button").show();
                });
            }).then(()=>{    
  document.getElementById('rzp-button1').onclick = function(e){
console.log(amount);
     var options = {
        
      "key": "rzp_test_09tqEjGt9Zl7Ll", // Enter the Key ID generated from the Dashboard
      "amount": amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",
      "name": "Acme Corp",
      "description": "Test Transaction",
      "image": "https://dynamic.brandcrowd.com/asset/logo/a2ea32a5-2049-44d3-813b-6e895d00a61f/logo-search-grid-1x?logoTemplateVersion=1&v=637662604811930000",
      "order_id": orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response){
        console.log(response);
          alert(response.razorpay_payment_id);
          alert(response.razorpay_order_id);
          alert(response.razorpay_signature)
        var settings = {
        "url": "/api/payment/verify",
        "method": "POST",
        "timeout": 0,
        "headers": {
         "Content-Type": "application/json"
          },
    "data": JSON.stringify({response}),
  }
        $.ajax(settings).done(function (response) {
          alert(JSON.stringify({response}));
        })
      },
      "theme": {
          "color": "#3399cc"
      }
  };
  var rzp1 = new Razorpay(options);
  rzp1.on('payment.failed', function (response){
          alert(response.error.code);
          alert(response.error.description);
          alert(response.error.source);
          alert(response.error.step);
          alert(response.error.reason);
          alert(response.error.metadata.order_id);
          alert(response.error.metadata.payment_id);
  });
      rzp1.open();
      e.preventDefault();
  }
});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
 
    </body>
</html>